# dhtt_base

## Overview

This is the main repository for dynamic Hierarchical Task Trees (dHTTs) which are a hierarchical tree based task representation. The purpose of this is to offer an architecture for behavior-based control of a robot which can accept and follow changes made to the task at runtime.

### License

GNU GENERAL PUBLIC LICENSE

**Authors: Tyler J Becker, and William (Stosh) Peterson<br />
Affiliation: [Robotics Research Lab: University of Nevada, Reno](https://rrl.cse.unr.edu/en/)<br />
Maintainer: Tyler J Becker, tbecker@unr.edu**

This package has been tested on [ROS2] Foxy with Ubuntu 20.04.
This is research code, expect that it changes often and any known fitness for a particular purpose is disclaimed.

## Basic Description
![Example image](assets/figure_server_architecture1.png)

The dHTT server contains an internal hierarchically represented task. The changes that in general can be made at runtime are: adding and removing subtasks and behaviors, adding and removing resources, changing node parameters, changing node types, and pausing and starting the task.


### Publications

If you use this work in an academic context, please cite the following publication(s):

        @unpublished{beckerdhtt,
		    author = {Becker, Tyler J and Peterson, William and Feil-Seifer, David and Nicolescu, Monica},
		    title = {Dynamic Hierarchical Task Trees: A Representation for Tasks with Changing Requirements},
		    note = {submitted for publication},
		    year={2025}
		}

### Installation

TO DO!

### Building from Source

#### Dependencies

- [Robot Operating System 2 (ROS2) Minimum Version Foxy](https://docs.ros.org/en/foxy/index.html)
- [Yaml-cpp]

#### Building

To build from source, clone the latest version from this repository into your catkin workspace and compile the package using

	cd catkin_workspace/src
	git clone https://github.com/tylerjohnbecker/dhtt_base.git
	cd ../
	colcon build --packages-select dhtt dhtt_msgs dhtt_plugins

### Unit Tests

Run the unit tests by first starting the dhtt main server application with:

	ros2 launch dhtt start_server.launch test:=true

Then in a new terminal run 

	colcon test --packages-select dhtt --event-handlers console_cohesion+

All tests are stored in the tests folder of the dhtt package.

## Usage

Describe the quickest way to run this software, for example:

Run the main node with

	ros2 launch dhtt start_server.launch 

This server can then be interacted with through the exposed services that are described below.

In general, the server should be started. Nodes and subtrees will then be added from the modify_service. Then, the tree can be started with the control_service. 

## Documentation

Documentation for this project is generated by using [Doxygen](https://doxygen.nl/). To generate the documentation locally just run the following in the root directory of the project:

	doxygen config

Documentation is also hosted through github-pages here: [docs](https://tylerjohnbecker.github.io/dhtt_base/html/index.html)

## Description files

Subtrees that can be added through the modify_service are described in .yaml files. Examples are shown in [/dhtt/sample_tasks](/dhtt/sample_tasks).

The structure of the tree descriptions should be at least the following:

	# a list of all the nodes in this file by name
	NodeList:
		- Node1
		- Node2
	# each nodes description
	Node:
		# example task node description
		Node1:
			type: 2 # type integers are described in [/dhtt_msgs/msg/Node.msg](/dhtt_msgs/msg/Node.msg).
			behavior_type: "dhtt_plugins::ThenBehavior" # must refer to a NodeType plugin.
			robot: 0 # in the case of multiple robots
			parent: 'NONE' # if the parent is None than this node is the root of the subtree
			params: [] # node specific parameters go here as a list of strings with the format "key: value"
			potential_type: 'dhtt_plugins::EfficiencyPotential' # optional efficiency computation plugin. Default value is 'dhtt_plugins::EfficiencyPotential'
		Node2:
			type: 4
			behavior_type: "dhtt_plugins::MoveBehavior"
			robot: 0
			parent: 'Node1'
			params: ['dest: location_1'] # these are always just specific to the parameters of the node


## Launch files

### start_server.launch

Generally, this is the main launch file to run the dhtt_server from.

#### Arguments

* **`with_world_params`** (bool): 
	
	If true then the params file given in params_file will be loaded into the main servers param server on startup. This is mostly unused at the moment.

* **`params_file`** (string): 

	Params file to load from. An example file is shown at dhtt/tests/test_world_states/world_1.yaml

* **`debug`** (bool):

	If true starts the node in a gdb server on 'localhost:2159'.

* **`test`** (bool):

	If true the root node has a wait in the activation loop that will slow the server down. For the unit tests specifically they rely on this wait to achieve consistent outputs when dynamic changes are given to the server.

## Nodes

### dHTT_server

Main server for interaction with the client. Contains helpful services that facilitate safely making modifications to the tree.

#### Subscribed Topics

* **`/status`** ([dhtt_msgs/msg/Node])

	A catch all topic that all Nodes in the tree use to report status changes to the server.

#### Published Topics

* **`/root_status`** ([dhtt_msgs/msg/NodeStatus])

	External topic to specifically report the status of the root node for monitoring the completion status of the tree as a whole. Listening here prevents the needs for filtering out other nodes from the `/status` topic.

#### Services

* **`/control_service`** ([dhtt_msgs/srv/ControlRequest])

	Performs any control requests for the server such as: starting/stopping execution, saving the current tree to a file, and resetting the tree.

* **`/fetch_service`** ([dhtt_msgs/srv/FetchRequest])

	Returns information about the current tree. This service can specifically search by type, name, etc.

* **`/history_service`** ([dhtt_msgs/srv/HistoryRequest])

	Returns information about the order in which nodes have been executed by the tree. Useful for testing and also for following the activation of each node.

* **`/modify_service`** ([dhtt_msgs/srv/ModifyRequest])

	Handles all modification type requests for the tree. This includes adding/removing nodes, updating parameters of nodes, and changing node types (mutation). These changes can be made either before or during runtime.

* **`/resource_service`** ([dhtt_msgs/srv/ResourceRequest])

	Resource requests can refer to either adding or removing resources from the tree. This method should be used for resources that have been updated by the environment itself rather than the dHTT agent.

#### Parameters

N/A

